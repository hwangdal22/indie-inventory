<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real-time BTCUSDT Chart</title>
    <script src="https://unpkg.com/lightweight-charts@3.7.1/dist/lightweight-charts.standalone.production.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        #chart-container {
            width: 100%;
            height: 500px;
            position: relative;
        }
        #bar-chart-container {
            width: 100%;
            height: 500px;
            position: relative;
        }
    </style>
</head>
<body>
    <h1>Real-time BTCUSDT Chart</h1>
    
    <!-- 캔들스틱 차트 -->
    <div id="chart-container"></div>
    
    <!-- 바 차트 (Buy/Sell Count & Volume) -->
    <div id="bar-chart-container"></div>

    <script type="text/javascript">
        // 차트 초기화
        var chart = LightweightCharts.createChart(document.getElementById('chart-container'), {
            width: 800,
            height: 400,
            title: 'BTCUSDT Real-Time Candlestick Chart'
        });

        var candleSeries = chart.addCandlestickSeries({
            upColor: 'green',
            borderUpColor: 'green',
            wickUpColor: 'green',
            downColor: 'red',
            borderDownColor: 'red',
            wickDownColor: 'red'
        });

        // 바 차트 초기화
        var barChart = LightweightCharts.createChart(document.getElementById('bar-chart-container'), {
            width: 800,
            height: 400,
            title: 'Buy/Sell Count & Volume'
        });

        var buyCountSeries = barChart.addBarSeries({ color: 'green' });
        var sellCountSeries = barChart.addBarSeries({ color: 'red' });
        var buyVolumeSeries = barChart.addBarSeries({ color: 'blue' });
        var sellVolumeSeries = barChart.addBarSeries({ color: 'orange' });

        // 데이터 업데이트 함수
        function updateCharts() {
            $.ajax({
                url: '/data',
                type: 'GET',
                success: function(res) {
                    var timestamps = res.timestamps.map(ts => new Date(ts).getTime() / 1000);  // Convert to Unix timestamp
                    var ohlc = res.open_prices.map((_, i) => ({
                        time: timestamps[i],
                        open: res.open_prices[i],
                        high: res.high_prices[i],
                        low: res.low_prices[i],
                        close: res.close_prices[i]
                    }));

                    candleSeries.setData(ohlc);

                    // 바 차트 데이터 업데이트
                    var buyCount = res.buy_counts.map((count, i) => ({ time: timestamps[i], value: count }));
                    var sellCount = res.sell_counts.map((count, i) => ({ time: timestamps[i], value: -count }));
                    var buyVolume = res.buy_volumes.map((volume, i) => ({ time: timestamps[i], value: volume }));
                    var sellVolume = res.sell_volumes.map((volume, i) => ({ time: timestamps[i], value: -volume }));

                    buyCountSeries.setData(buyCount);
                    sellCountSeries.setData(sellCount);
                    buyVolumeSeries.setData(buyVolume);
                    sellVolumeSeries.setData(sellVolume);
                }
            });
        }

        // 일정 간격(5초)마다 차트를 갱신
        setInterval(updateCharts, 5000);
    </script>
</body>
</html>
