<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real-time BTCUSDT Chart</title>
<script
    type="text/javascript"
    src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"
></script>    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
    <h1>Real-time BTCUSDT Chart</h1>
    
    <!-- 캔들스틱 차트 -->
    <div id="candlestick-chart" style="width:100%; height:500px;"></div>
    
    <!-- 바 차트 (Buy/Sell Count & Volume) -->
    <div id="bar-chart" style="width:100%; height:500px;"></div>

    <script type="text/javascript">
        // 캔들스틱 차트 초기화
        const candlestickChart = LightweightCharts.createChart(document.getElementById('candlestick-chart'), {
            width: window.innerWidth,
            height: 500,
            layout: { backgroundColor: '#ffffff' },
            crossHair: { mode: 0 }
        });

        const candlestickSeries = candlestickChart.addCandlestickSeries({
            upColor: 'green',
            borderUpColor: 'green',
            wickUpColor: 'green',
            color: 'red',
            borderDownColor: 'red',
            wickDownColor: 'red',
        });

        // 바 차트 초기화
        const barChart = LightweightCharts.createChart(document.getElementById('bar-chart'), {
            width: window.innerWidth,
            height: 500,
            layout: { backgroundColor: '#ffffff' }
        });

        const buyVolumeSeries = barChart.addHistogramSeries({
            color: 'blue',
            priceLineVisible: false
        });

        const sellVolumeSeries = barChart.addHistogramSeries({
            color: 'orange',
            priceLineVisible: false
        });

        const buyCountSeries = barChart.addLineSeries({
            color: 'green'
        });

        const sellCountSeries = barChart.addLineSeries({
            color: 'red'
        });

        // 차트를 갱신하는 함수
        function updateCharts() {
            $.ajax({
                url: '/data',  // Flask API로부터 데이터를 가져옴
                type: 'GET',
                dataType: 'json',
                success: function(res) {
                    const timestamps = res.timestamps;
                    const ohlcData = timestamps.map((timestamp, index) => ({
                        time: timestamp,
                        open: res.open_prices[index] || 0,
                        high: res.high_prices[index] || 0,
                        low: res.low_prices[index] || 0,
                        close: res.close_prices[index] || 0
                    }));

                    candlestickSeries.setData(ohlcData);

                    // 바 차트 데이터 업데이트
                    buyVolumeSeries.setData(timestamps.map((timestamp, index) => ({
                        time: timestamp,
                        value: res.buy_volumes[index] || 0
                    })));

                    sellVolumeSeries.setData(timestamps.map((timestamp, index) => ({
                        time: timestamp,
                        value: -res.sell_volumes[index] || 0  // 음수로 변환
                    })));

                    buyCountSeries.setData(timestamps.map((timestamp, index) => ({
                        time: timestamp,
                        value: res.buy_counts[index] || 0
                    })));

                    sellCountSeries.setData(timestamps.map((timestamp, index) => ({
                        time: timestamp,
                        value: -res.sell_counts[index] || 0  // 음수로 변환
                    })));
                },
                error: function(err) {
                    console.error('Error fetching data:', err);
                }
            });
        }

        // 일정 간격(5초)마다 차트를 갱신
        setInterval(updateCharts, 5000);

        // 초기 차트 데이터 로딩
        updateCharts();
    </script>
</body>
</html>
